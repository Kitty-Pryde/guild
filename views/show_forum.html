{% extends 'layouts/master.html' %}
{% import 'macros/paginate.html' as paginate %}
{% import 'macros/macros.html' as macros %}

{% block embed %}
  <ol class="breadcrumb">
    <li>
      <a href="/">Home</a>
    </li>
  </ol>

  <!-- Viewers -->
  {{ macros.renderViewers(viewers) }}

  <!-- Page header -->

  <div class="page-header" style="border-color: #000">
    <h3><a href="{{ forum.url }}" style="color: #fff">{{ forum.title }}</a></h3>
    {% if forum.description %}
      <div>{{ forum.description }}</div>
    {% endif %}
  </div>

  <!-- Force latest_post_id and latest_post_at refresh -->
  {% if ctx.can(ctx.currUser, 'REFRESH_FORUM', forum) %}
    <div class="well well-sm">
      <form action="{{ forum.url }}/refresh" method="post">
        <button class="btn btn-default btn-xs">
          Refresh Forum
        </button>
        <span>Recalculate forum's latest post to ignore hidden topics. Use this to fix a forum when you hide a spambot's topic and it still shows up as the forum's latest post</span>
      </form>
    </div>
  {% endif %}

  {{ paginate.render(currPage, totalPages, forum.url) }}


  <!-- New Topic button -->

  {% if ctx.can(ctx.currUser, 'CREATE_TOPIC', forum) %}
    <a class="btn btn-primary pull-right" href="{{ forum.url }}/topics/new">
      <span class="glyphicon glyphicon-pencil"></span>
      {% if forum.is_roleplay %}
        New Roleplay
      {% else %}
        New Topic
      {% endif %}
    </a>
  {% endif %}

  <!-- Tabs -->

  {% if forum.parent_forum  %}
    <ul class="nav nav-tabs forum-tabs">
      <li><a href="{{ forum.parent_forum.url }}">Roleplays</a></li>
      <li class="active"><a href="{{ forum.url }}">Interest Checks</a></li>
    </ul>
  {% endif %}

  {% if forum.child_forum  %}
    <ul class="nav nav-tabs forum-tabs">
      <li class="active"><a href="{{ forum.url }}">Roleplays</a></li>
      <li><a href="{{ forum.child_forum.url }}">Interest Checks</a></li>
    </ul>
  {% endif %}

  {% if (!forum.child_forum && !forum.parent_forum && !forum.is_roleplay) %}
    <ul class="nav nav-tabs forum-tabs">
      <li class="active"><a href="{{ forum.url }}">Topics</a></li>
    </ul>
  {% endif %}

  <!-- Topic list -->

  {% if forum.topics.length === 0 %}
    <div class="well">
      This forum has no topics yet.
    </div>
  {% endif %}

  {% if forum.topics.length > 0 %}
    <div class="list-group">
      <div class="list-group-item"
           style="background-color: #1D1D1D; border: 1px solid #111;">
        <div class="row">
          <div class="col-xs-6">Topics</div>
          <div class="col-xs-1"></div>
          <div class="col-xs-2">Posts</div>
          <div class="col-xs-3">Latest Post</div>
        </div> <!-- /.row -->
      </div><!-- /.list-group-item -->
      {% for topic in forum.topics %}
        {% if ctx.can(ctx.currUser, 'READ_TOPIC', topic) %}
          <div class="list-group-item topic-item
                      {% if topic.has_posted %}
                        topic-item-current-user-posted
                      {% endif %}
                      "
               style="background-color: #3d3a3a; border: 1px solid #111; color: #fff;">
            <div class="row">
              <div class="col-xs-6">
                <h5 class="list-group-item-heading topic-panel-title">
                  {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                    <span class="glyphicon glyphicon-share-alt"></span>
                  {% endif %}
                  {% if topic.is_closed %}
                    <span class="label label-default">Closed</span>
                  {% endif %}
                  {% if topic.is_hidden %}
                    <span class="label label-warning">Hidden</span>
                  {% endif %}
                  {% if topic.is_sticky %}
                    <span class="label label-primary">Sticky</span>
                  {% endif %}
                  <a href="{{ topic.url }}">{{ topic.title }}</a>
                </h5>
                <p class="list-group-item-text">
                  <div style="margin-top: 6px;">
                    by <a href="{{ topic.user.url }}" style="color: #fff">
                      {{ topic.user.uname -}}
                    </a>,
                    <abbr class="timeago"
                          title="{{ topic.created_at.toISOString() }}">
                      {{ topic.created_at|formatDate }}
                    </abbr>
                  </div>
                  <!-- List topic tags -->
                  {% if topic.tags %}
                    <ul class="list-inline" style="margin: 0;">
                      {% for tag in topic.tags %}
                        <!-- Ignore tag if we're in the "tag's forum" -->
                        {% if tag.id !== forum.tag_id %}
                          <li data-toggle="tooltip" title="{{ tag.description }}"
                              style="padding: 0;">
                            <span class="label label-default">{{ tag.title }}</span>
                          </li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  {% endif %}
                </p>
              </div> <!-- /col6 -->
              {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                <div class="col-xs-6">
                  Moved to
                  <a href="/forums/{{ topic.forum_id }}">
                    {{ topic.forum.title -}}
                  </a>
                  <div>
                    <abbr class="timeago" title="{{ topic.moved_at.toISOString() }}">
                      {{ topic.moved_at|formatDate }}
                    </abbr>
                  </div>
                </div> <!-- /col-6 -->
              {% else %}
                <div class="col-xs-1"></div>
                <div class="col-xs-2">{{ topic.posts_count|commafy }}</div>
                <!-- Latest post -->
                <div class="col-xs-3">
                  <div>
                    by <a href="{{ topic.latest_user.url }}" style="color: #fff">{{ topic.latest_user.uname }}</a>
                  <a href="{{ topic.latest_post.url }}">
                    <span class="glyphicon glyphicon-link"></span>
                    &rarr;
                  </a>
                  </div>
                  <abbr class="timeago"
                        title="{{ topic.latest_post.created_at.toISOString() }}">
                    {{ topic.latest_post.formattedCreatedAt }}
                  </abbr>
                </div>
              {% endif %} <!-- /if moved -->
            </div> <!-- /.row -->
          </div> <!-- /.list-group-item -->
        {% endif %}
      {% endfor %}
    </div> <!-- /.list-group -->
  {% endif %}

  <!-- Top -->
  <div style="display: block; margin-bottom: 20px;">
    <a href="#" class="top-link">&uarr; Top</a>
  </div>

  <!-- New Topic button -->

  {% if ctx.can(ctx.currUser, 'CREATE_TOPIC', forum) %}
    <a class="btn btn-primary pull-right" href="{{ forum.url }}/topics/new">
      <span class="glyphicon glyphicon-pencil"></span>
      {% if forum.is_roleplay %}
        New Roleplay
      {% else %}
        New Topic
      {% endif %}
    </a>
  {% endif %}

  <!-- Viewers -->
  {{ macros.renderViewers(viewers) }}

  {{ paginate.render(currPage, totalPages, forum.url) }}

{% endblock %}

{% block scripts %}
  <script type="text/javascript">
    // Activate tag tooltips
    $('[data-toggle="tooltip"]').tooltip()
  </script>
{% endblock %}
