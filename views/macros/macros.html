
{% macro onlineStatus(user) %}
  {% if user.is_ghost %}
    {% if ctx.can(ctx.currUser, 'READ_USER_ONLINE_STATUS', user) %}
      <span style="color: #000">Invisible</span>
    {% endif %}
  {% else %}
    {% if Date.now() - user.last_online_at.getTime() < 1000 * 60 * 15 %}
      <span style="color: #3BB878">Online</span>
    {% else %}
      {% if user.last_online_at %}
        <span style="color: #777">
          Online
          <abbr class="timeago"
                title="{{ user.last_online_at.toISOString() }}">
            {{ user.last_online_at|formatDate }}
          </abbr>
        </span>
      {% else %}
        <span style="color: #555">
          Offline since relaunch
        </span>
      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro renderPost(post) %}
  {% if post.html %}
    <div class="post-body-html post-content">{{- post.html|safe -}}</div>
  {% elif post.legacy_html %}
    <div class="post-body-html post-content">{{- post.legacy_html|safe -}}</div>
  {% else %}
    <div class="post-body post-content">{{- post.text -}}</div>
  {% endif %}
{% endmacro %}

{% macro renderSig(user) %}
  {% if ctx.currUser && !ctx.currUser.hide_sigs && user.sig_html %}
    <div class="post-sig-legacy post-sig">
      {{- post.user.sig_html|safe -}}
    </div>
  {% endif %}
{% endmacro %}

{% macro renderUserbitSmall(user) %}
    <div class="media">
      {% if !ctx.currUser || (user.avatar_url && !ctx.currUser.hide_avatars) %}
        <a class="media-left" href="{{ post.user.url }}">
          <img class="avatar-img {% if ctx.currUser.is_grayscale %}desaturate{% endif %}"
               src="{{ post.user.avatar_url }}"
               alt="Avatar of {{ post.user.uname }}"
               title="Avatar of {{ post.user.uname }}"
               style="max-width: 40px; max-height: 40px;"
               >
        </a>
      {% endif %}
      <div class="media-body" style="text-align: left;">
        <h4 class="media-heading" style="margin-bottom: 0;">
          <a href="{{ post.user.url }}">
            {{ user.uname }}
          </a>
          {% if user.custom_title %}
            <small><span class="text-muted">{{ user.custom_title|replaceTitleNewlinesMobile|raw }}</span></small>
          {% endif %}
        </h4>
        <div class="pull-left">
          {{ user.role|capitalize }}
          {{ macros.onlineStatus(user) }}
        </div>
      </div>
    </div>
{% endmacro %}

{% macro renderUserbitLarge(user)  %}
  <div class="user-uname">
    <a href="{{ user.url }}">
      {{ user.uname }}
    </a>
  </div>

  {% if user.custom_title %}
    <div class="user-custom-title text-muted">
      {{ user.custom_title|replaceTitleNewlines|raw }}
    </div>
  {% endif %}

  {% if !ctx.currUser || (user.avatar_url && !ctx.currUser.hide_avatars) %}
    <div class="post-avatar"
         style="margin-top: 10px;">
      <img class="avatar-img {% if ctx.currUser.is_grayscale %}desaturate{% endif %}"
           src="{{ user.avatar_url}}"
           alt="Avatar of {{ user.uname }}"
           title="Avatar of {{ user.uname }}">
    </div>
  {% endif %}

  <div class="user-role" style="margin-top: 10px;">
    {% if user.id === 10 %}
      <img src="/bling/10-sora/legacy.gif">
      <img src="/bling/10-sora/member.gif">
      <br>
      <img src="/bling/10-sora/forever.gif">
    {% elif user.role === 'member' %}
    {% else %}
      {{ user.role|capitalize }}
    {% endif %}
  </div>

  <div class="user-stats">
    {{ user.posts_count }} posts in {{ user.created_at|daysAgo}} days
  </div>

  <!-- Online status -->

  {{ onlineStatus(user) }}

  <!-- User gylphs -->

  {% if user.bio_markup %}
    <div class="user-glyphs">
      <a href="{{ user.url }}#bio">
        <img src="/img/bio1.gif" width="22" height="12"
             alt="Read bio of {{ user.uname }}"
             title="Read bio of {{ user.uname }}">
      </a>
    </div>
  {% endif %}
{% endmacro %}

{% macro renderViewers(viewers) %}
  {% set userCount = viewers.users.length %}
  {% set guestCount = viewers.guests.length %}
  {% if userCount > 0 || guestCount > 0 %}
    <div class="viewers">
      {% if userCount > 0 %}
        {{ userCount }} User{% if userCount > 1 %}s{% endif %}
      {% endif %}
      {% if userCount > 0 && guestCount > 0%}
        and
      {% endif %}
      {% if guestCount > 0 %}
        {{ guestCount }} Guest{% if guestCount > 1 %}s{% endif %}
      {% endif %}
      viewing this page
      <br>
      <ul class="list-inline">
        {% for viewer in viewers.users %}<li><a href="/users/{{ viewer.uname|slugifyUname }}">{{- viewer.uname -}}</a>{% if !loop.last %},{% endif %}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}
{% endmacro %}

{% macro renderTagInputs(tagGroups, selectedTagIds) %}
  {% set selectedTagIds = selectedTagIds || [] %}

  <input type="hidden" name="tag-ids[]" value="-1">
  {% for group in tagGroups %}
    <div class="row">
      <div class="col-sm-2">
        {{ group.title }}:
      </div><!--/col1-->

      <div class="col-sm-10">
        <div class="btn-group" data-toggle="buttons">
          {% for tag in group.tags %}
            <label class="btn btn-default btn-xs {% if tag.id|isIn(selectedTagIds) %}active{% endif %}"
                   data-toggle="tooltip" title="{{ tag.description }}">
              <input name="tag-ids[]" type="checkbox" autocomplete="off" value="{{ tag.id }}" {% if tag.id|isIn(selectedTagIds) %}checked="checked"{% endif %}>
              {{ tag.title }}
            </label>
          {% endfor %}
       </div><!--/btn-group-->
      </div><!--/col2-->
    </div><!--/row-->
  {% endfor %}
{% endmacro %}

{% macro renderSidebar(latestChecks, latestRoleplays) %}

  <!-- Current contest -->

  <div class="panel panel-default" style="background: transparent;">
    <div class="panel-body">
      <h4 style="margin-bottom: 20px;" class="text-center">
        <img src="/img/trophy.png" height="32" width="32"
             alt="Contests Icon"
             title="Contests Icon"> Current Contest
      </h4>
      <div class="text-center">
        <!-- Link to contest -->
        <a href="/topics/77523">RPGC #1: Inspired by a song</a>
        <!-- Prompt -->
        <br>
        <small style="font-style: oblique">Choose any song you want and write a story or poem based on or inspired by that song.</small>
        <!-- Deadline -->
        <div style="margin-top: 15px;" class="text-muted text-left"><small>Submit entry by: <u>March 15th</u></small></div>
      </div>
    </div>
  </div>

  <!-- Latest checks -->

  <div class="panel panel-default" style="background: transparent;">
    <div class="panel-body">

      <h4 style="margin-bottom: 20px;" class="text-center">Latest Checks</h4>
      {% for topic in latestChecks %}
        <div>
          <a href="{{ topic.url }}">{{ topic.title }}</a>
          <div>
            by <a href="{{ topic.user.url }}" style="color: white;">{{ topic.user.uname }}</a>
            <span class="text-muted" style="display: inline-block;">
              &mdash;
              <abbr class="timeago" title="{{ topic.created_at.toISOString() }}">
                {{ topic.created_at|formatDate }}
              </abbr>
            </span>
          </div>
          <div>
            {% for tag in topic.tags %}
              <span class="label label-default" style="display: inline-block;"
                    data-toggle="tooltip" title="{{ tag.description }}">
                {{ tag.title }}
              </span>
            {% endfor %}
          </div>
        </div>
        {% if !loop.last %}<hr>{% endif %}
      {% endfor %}

    </div><!-- /panel-body -->
  </div><!-- /panel-default -->

  <!-- Latest Roleplays -->

  <div class="panel panel-default" style="background: transparent;">
    <div class="panel-body">

      <h4 style="margin-bottom: 20px;" class="text-center">Latest Roleplays</h4>
      {% for topic in latestRoleplays %}
        <div>
          <a href="{{ topic.url }}">{{ topic.title }}</a>
          <div>
            by <a href="{{ topic.user.url }}" style="color: white;">{{ topic.user.uname }}</a>
            <span class="text-muted" style="display: inline-block;">
              &mdash;
              <abbr class="timeago" title="{{ topic.created_at.toISOString() }}">
                {{ topic.created_at|formatDate }}
              </abbr>
            </span>
          </div>
          <div>
            {% for tag in topic.tags %}
              <span class="label label-default" style="display: inline-block;"
                    data-toggle="tooltip" title="{{ tag.description }}">
                {{ tag.title }}
              </span>
            {% endfor %}
          </div>
        </div>
        {% if !loop.last %}<hr>{% endif %}
      {% endfor %}

    </div><!-- /panel-body -->
  </div><!-- /panel-default -->

{% endmacro %}

<!-- Item rendering -->

<!-- Roleplay items -->
{% macro renderRoleplayItemHeading(topic, forum) %}
  <div class="col-xs-1 hidden-xs"></div>
  <div class="col-xs-6 hidden-xs">Roleplays</div>
  <div class="col-xs-5 hidden-xs text-right">Latest Post</div>
  <div class="col-xs-6 visible-xs-block">Roleplays</div>
  <div class="col-xs-6 visible-xs-block text-right">Latest Post</div>
{% endmacro %}

{% macro renderRoleplayItem(topic, forum) %}
          <div class="list-group-item topic-item
                      {% if topic.has_posted %}
                        topic-item-current-user-posted
                      {% endif %}
                      "
               style="background-color: #3d3a3a; border: 1px solid #111; color: #fff;">
            <div class="row">
              <div class="col-sm-1">
                {% if topic.join_status %}
                  <div class="join-status join-status-{{ topic.join_status }}">
                    <abbr title="{{ topic.join_status|expandJoinStatus }}" data-toggle="tooltip">
                      {{ topic.join_status|capitalize }}
                    </abbr>
                  </div>
                {% endif %}
              </div>
              <div class="col-sm-6">
                <h5 class="list-group-item-heading topic-panel-title">
                  {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                    <span class="glyphicon glyphicon-share-alt" title="Moved" data-toggle="tooltip"></span>
                  {% endif %}
                  {% if topic.is_closed %}
                    <span class="glyphicon glyphicon-lock text-muted" title="Closed" data-toggle="tooltip"></span>
                  {% endif %}
                  {% if topic.is_hidden %}
                    <span class="label label-warning">Hidden</span>
                  {% endif %}
                  {% if topic.is_sticky %}
                    <span class="glyphicon glyphicon-pushpin" style="color: #2FAECE;" title="Sticky" data-toggle="tooltip"></span>
                  {% endif %}
                  <a href="{{ topic.url }}">{{ topic.title }}</a>
                </h5>
                <div class="list-group-item-text">
                  <div style="margin-top: 6px;">
                    by <a href="{{ topic.user.url }}" style="color: #fff">
                      {{ topic.user.uname -}}
                    </a>,
                    <abbr class="timeago created-at"
                          title="{{ topic.created_at.toISOString() }}">
                      {{ topic.created_at|formatDate }}
                    </abbr>
                  </div>
                  <!-- List topic tags -->
                  {% if topic.tags %}
                    <ul class="list-inline" style="margin: 0;">
                      {% for tag in topic.tags %}
                        <!-- Ignore tag if we're in the "tag's forum" -->
                        {% if tag.id !== forum.tag_id %}
                          <li data-toggle="tooltip" title="{{ tag.description }}"
                              style="padding: 0;">
                            <span class="label label-default">{{ tag.title }}</span>
                          </li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
              </div> <!-- /col6 -->
              {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                <div class="col-sm-6">
                  Moved to
                  <a href="/forums/{{ topic.forum_id }}">
                    {{ topic.forum.title -}}
                  </a>
                  <div>
                    <abbr class="timeago moved-at" title="{{ topic.moved_at.toISOString() }}">
                      {{ topic.moved_at|formatDate }}
                    </abbr>
                  </div>
                </div> <!-- /col-6 -->
              {% else %}
                <div class="col-sm-2">
                  <div class="text-muted">{{ topic.posts_count|commafy }} Posts</div>
                </div>
                <!-- Latest post -->
                <div class="col-sm-3">
                  <div class="latest-post text-right">
                    Latest:
                      by <a href="{{ topic.latest_user.url }}" style="color: #fff">{{ topic.latest_user.uname }}</a>
                    <a href="{{ topic.latest_post.url }}" class="btn btn-default btn-xs">
                      Go
                      &rarr;
                    </a>
                    <br>
                    <abbr class="timeago created-at"
                          title="{{ topic.latest_post.created_at.toISOString() }}">
                      {{ topic.latest_post.created_at|formatDate }}
                    </abbr>
                  </div>
                </div>
              {% endif %} <!-- /if moved -->
            </div> <!-- /.row -->
          </div> <!-- /.list-group-item -->
{% endmacro %}

<!-- Check items -->
{% macro renderCheckItemHeading(topic, forum) %}
  <div class="col-xs-7">
    {% if forum.is_roleplay %}
      Roleplays
    {% else %}
      Interest Checks
    {% endif %}
  </div>
  <div class="col-xs-5 text-right">Latest Post</div>
{% endmacro %}

{% macro renderCheckItem(topic, forum) %}
          <div class="list-group-item topic-item
                      {% if topic.has_posted %}
                        topic-item-current-user-posted
                      {% endif %}
                      "
               style="background-color: #3d3a3a; border: 1px solid #111; color: #fff;">
            <div class="row">
              <div class="col-sm-6">
                <h5 class="list-group-item-heading topic-panel-title">
                  {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                    <span class="glyphicon glyphicon-share-alt" title="Moved" data-toggle="tooltip"></span>
                  {% endif %}
                  {% if topic.is_closed %}
                    <span class="glyphicon glyphicon-lock text-muted" title="Closed" data-toggle="tooltip"></span>
                  {% endif %}
                  {% if topic.is_hidden %}
                    <span class="label label-warning">Hidden</span>
                  {% endif %}
                  {% if topic.is_sticky %}
                    <span class="glyphicon glyphicon-pushpin" style="color: #2FAECE;" title="Sticky" data-toggle="tooltip"></span>
                  {% endif %}
                  <a href="{{ topic.url }}">{{ topic.title }}</a>
                </h5>
                <div class="list-group-item-text">
                  <div style="margin-top: 6px;">
                    by <a href="{{ topic.user.url }}" style="color: #fff">
                      {{ topic.user.uname -}}
                    </a>,
                    <abbr class="timeago created-at"
                          title="{{ topic.created_at.toISOString() }}">
                      {{ topic.created_at|formatDate }}
                    </abbr>
                  </div>
                  <!-- List topic tags -->
                  {% if topic.tags || topic.join_status %}
                    <ul class="list-inline" style="margin: 0;">
                      {% if topic.join_status %}
                        <li class="join-status join-status-{{ topic.join_status }}" style="padding-left: 0;">
                          <abbr title="{{ topic.join_status|expandJoinStatus }}" data-toggle="tooltip">
                            {{ topic.join_status|capitalize }}
                          </abbr>
                        </li>
                      {% endif %}
                      {% for tag in topic.tags %}
                        <!-- Ignore tag if we're in the "tag's forum" -->
                        {% if tag.id !== forum.tag_id %}
                          <li data-toggle="tooltip" title="{{ tag.description }}"
                              style="padding: 0;">
                            <span class="label label-default">{{ tag.title }}</span>
                          </li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
              </div> <!-- /col6 -->
              {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                <div class="col-sm-6">
                  Moved to
                  <a href="/forums/{{ topic.forum_id }}">
                    {{ topic.forum.title -}}
                  </a>
                  <div>
                    <abbr class="timeago moved-at" title="{{ topic.moved_at.toISOString() }}">
                      {{ topic.moved_at|formatDate }}
                    </abbr>
                  </div>
                </div> <!-- /col-6 -->
              {% else %}
                <div class="col-sm-2">
                  <div class="text-muted">{{ topic.posts_count|commafy }} Posts</div>
                </div>
                <!-- Latest post -->
                <div class="col-sm-4">
                  <div class="latest-post text-right">
                    Latest:
                      <span class="by-line">
                        <a href="{{ topic.latest_user.url }}" style="color: #fff">{{ topic.latest_user.uname }}</a>
                      </span>
                    <a href="{{ topic.latest_post.url }}" class="btn btn-default btn-xs" style="margin-left: 5px;">
                      Go
                      &rarr;
                    </a>
                    <br>
                    <abbr class="timeago created-at"
                          title="{{ topic.latest_post.created_at.toISOString() }}">
                      {{ topic.latest_post.created_at|formatDate }}
                    </abbr>
                  </div>
                </div>
              {% endif %} <!-- /if moved -->
            </div> <!-- /.row -->
          </div> <!-- /.list-group-item -->
{% endmacro %}


<!-- Regular topics -->
{% macro renderTopicItemHeading(topic, forum) %}
  <div class="col-xs-6">Topics</div>
  <div class="col-xs-6 text-right">Latest Post</div>
{% endmacro %}

{% macro renderTopicItem(topic, forum) %}
          <div class="list-group-item topic-item
                      {% if topic.has_posted %}
                        topic-item-current-user-posted
                      {% endif %}
                      "
               style="background-color: #3d3a3a; border: 1px solid #111; color: #fff;">
            <div class="row">
              <div class="col-sm-6">
                <h5 class="list-group-item-heading topic-panel-title">
                  {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                    <span class="glyphicon glyphicon-share-alt" title="Moved" data-toggle="tooltip"></span>
                  {% endif %}
                  {% if topic.is_closed %}
                    <span class="glyphicon glyphicon-lock text-muted" title="Closed" data-toggle="tooltip"></span>
                  {% endif %}
                  {% if topic.is_hidden %}
                    <span class="label label-warning">Hidden</span>
                  {% endif %}
                  {% if topic.is_sticky %}
                    <span class="glyphicon glyphicon-pushpin" style="color: #2FAECE;" title="Sticky" data-toggle="tooltip"></span>
                  {% endif %}
                  <a href="{{ topic.url }}">{{ topic.title }}</a>
                </h5>
                <div class="list-group-item-text">
                  <div style="margin-top: 6px;">
                    by <a href="{{ topic.user.url }}" style="color: #fff">
                      {{ topic.user.uname -}}
                    </a>,
                    <abbr class="timeago created-at"
                          title="{{ topic.created_at.toISOString() }}">
                      {{ topic.created_at|formatDate }}
                    </abbr>
                  </div>
                </div>
              </div> <!-- /col6 -->
              {% if topic.moved_at && topic.moved_from_forum_id === forum.id %}
                <div class="col-sm-6">
                  Moved to
                  <a href="/forums/{{ topic.forum_id }}">
                    {{ topic.forum.title -}}
                  </a>
                  <div>
                    <abbr class="timeago moved-at" title="{{ topic.moved_at.toISOString() }}">
                      {{ topic.moved_at|formatDate }}
                    </abbr>
                  </div>
                </div> <!-- /col-6 -->
              {% else %}
                <div class="col-sm-2">
                  <div class="text-muted">{{ topic.posts_count|commafy }} Posts</div>
                </div>
                <!-- Latest post -->
                <div class="col-sm-4">
                  <div class="latest-post text-right">
                    Latest:
                      <span class="by-line">
                        <a href="{{ topic.latest_user.url }}" style="color: #fff">{{ topic.latest_user.uname }}</a>
                      </span>
                    <a href="{{ topic.latest_post.url }}" class="btn btn-default btn-xs" style="margin-left: 5px;">
                      Go
                      &rarr;
                    </a>
                    <br>
                    <abbr class="timeago created-at"
                          title="{{ topic.latest_post.created_at.toISOString() }}">
                      {{ topic.latest_post.created_at|formatDate }}
                    </abbr>
                  </div>
                </div>
              {% endif %} <!-- /if moved -->
            </div> <!-- /.row -->
          </div> <!-- /.list-group-item -->
{% endmacro %}


<!-- USER BAR -->


{% macro renderUserBar(clss) %}
  <div class="btn-group btn-group-sm {{ clss }}">
    <a href="/me/convos"
       class="btn btn-default navbar-btn">
      <span class="glyphicon glyphicon-envelope"></span>
      PMs
      {# Doing !==0 instead of >0 so user can see any bugs where
         notification count goes negative #}
      {% if ctx.currUser.convo_notifications_count !== 0 %}
      <div class="badge">
        {{ ctx.currUser.convo_notifications_count|commafy }}
      </div>
      {% endif %}
    </a>
    <a href="/me/subscriptions"
       class="btn btn-default navbar-btn">
      <span class="glyphicon glyphicon-list"></span>
      Subs
    </a>
    {% if ctx.can(ctx.currUser, 'LEXUS_LOUNGE') %}
      <a href="/lexus-lounge"
         class="btn btn-default navbar-btn">
        <span class="glyphicon glyphicon-eye-open"></span>
        Mod
      </a>
    {% endif %}

    <a href="/me/notifications" class="btn btn-default navbar-btn">
      <span class="glyphicon glyphicon-bell"></span>
      {% if ctx.currUser.notifications_count > 0 %}
        <div class="badge">
          {{ ctx.currUser.notifications_count|commafy }}
        </div>
      {% endif %}
    </a>

    <a href="/users/{{ ctx.currUser.id }}"
       class="btn btn-default navbar-btn">
      <span class="glyphicon glyphicon-user"></span>
      {{ ctx.currUser.uname }}
    </a>
  </div>
{% endmacro %}
